---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import bibFileRaw from '../data/publications.bib?raw';

// Fetch recent posts
const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
).slice(0, 3);

// --- BibTeX Parser Logic ---
interface Author {
	first: string;
	last: string;
}

interface BibEntry {
	type: string;
	key: string;
	fields: Record<string, string>;
	authors: Author[];
}

function parseBibTeX(input: string): BibEntry[] {
    const entries: BibEntry[] = [];
    const rawEntries = input.split(/@(\w+)\s*\{/g).slice(1);

    for (let i = 0; i < rawEntries.length; i += 2) {
        const type = rawEntries[i].trim();
        const body = rawEntries[i+1];
        if (!body) continue;

        const keyMatch = body.match(/^\s*([^,]+),/);
        const key = keyMatch ? keyMatch[1].trim() : 'unknown';
        
        const fields: Record<string, string> = { title: "Untitled", year: "0000" };
        const fieldRegex = /(\w+)\s*=\s*(?:\{((?:[^{}]|{[^{}]*})*)\}|"((?:[^"]|\\")*)"|(\d+))/g;
        
        let match;
        while ((match = fieldRegex.exec(body)) !== null) {
            const fieldKey = match[1].toLowerCase();
            const val = match[2] || match[3] || match[4] || "";
            fields[fieldKey] = val.replace(/\s+/g, ' ').trim();
        }

        let authors: Author[] = [];
        if (fields.author) {
            authors = fields.author.split(/\s+and\s+/i).map(str => {
                const parts = str.split(',');
                if (parts.length > 1) {
                    return { first: parts[1].trim(), last: parts[0].trim() };
                } else {
                    const names = str.trim().split(' ');
                    const last = names.pop() || "";
                    const first = names.join(' ');
                    return { first, last };
                }
            });
        }
        entries.push({ type, key, fields, authors });
    }
    return entries;
}

// Parse and get top 3 publications
const publications = parseBibTeX(bibFileRaw).sort((a, b) => {
    return (parseInt(b.fields.year) || 0) - (parseInt(a.fields.year) || 0);
}).slice(0, 3);

const formatAuthor = (auth: Author) => {
    return auth.first ? `${auth.first} ${auth.last}` : auth.last;
};
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			.hero {
				display: flex;
				align-items: center;
				gap: 4rem;
				padding: 4rem 0;
				margin-bottom: 2rem;
			}
			.hero-content { flex: 3; }
			.hero-image { 
				flex: 2; 
				text-align: center;
                position: relative;
			}
			.hero-image img {
				width: 280px;
				height: 280px;
				object-fit: cover;
				border-radius: 50%;
				border: 6px solid var(--color-bg);
				box-shadow: 0 0 0 1px var(--color-border), var(--shadow-lg);
			}
            
            /* Publication Mini List */
            .pub-mini-item {
                margin-bottom: 1.5rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid var(--color-border);
            }
            .pub-mini-item:last-child { border-bottom: none; margin-bottom: 0; }
            .pub-title { font-weight: 700; color: var(--color-text-main); display: block; margin-bottom: 0.25rem; font-family: var(--font-serif); font-size: 1.1rem; }
            .pub-meta { font-size: 0.9rem; color: var(--color-text-muted); }

			@media (max-width: 768px) {
				.hero { flex-direction: column-reverse; text-align: center; padding: 2rem 0; gap: 2rem; }
                .hero-image img { width: 200px; height: 200px; }
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<!-- Hero Section -->
			<section class="hero">
				<div class="hero-content">
					<h1 style="margin-bottom: 0.5rem; font-size: 3rem;">Albert Einstein</h1>
					<h4 style="font-weight: 400; color: var(--color-text-muted); margin-bottom: 1.5rem; font-family: var(--font-sans); text-transform: uppercase; letter-spacing: 0.05em; font-size: 1rem;">
						Professor of Theoretical Physics<br/>
						Institute for Advanced Study
					</h4>
					<p style="font-size: 1.1rem; line-height: 1.7; margin-bottom: 2rem;">
						Welcome to my academic portfolio. My research focuses on <strong>General Relativity, Quantum Mechanics, and Unified Field Theory</strong>. I lead the Theoretical Physics Group where we explore the fundamental laws governing the universe.
					</p>
					<div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <!-- Using inline styles for specific button needs or classes from global.css -->
						<a href="/publications" class="btn">View Publications</a>
						<a href="/projects" class="btn btn-outline">Current Projects</a>
					</div>
				</div>
				<div class="hero-image">
					<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Albert_Einstein_Head.jpg/480px-Albert_Einstein_Head.jpg" alt="Professor Portrait" />
				</div>
			</section>

			<hr style="margin: 3rem 0; border-top: 1px solid var(--color-border);" />

			<div class="grid-2" style="gap: 4rem; margin-top: 0;">
                <!-- Selected Research -->
                <section>
                    <h2 style="margin-top: 0;">Selected Publications</h2>
                    <div class="publication-list">
                        {publications.length > 0 ? publications.map((pub) => (
                            <div class="pub-mini-item">
                                <span class="pub-title">{pub.fields.title.replace(/[{}]/g, '')}</span>
                                <div class="pub-meta">
                                    {pub.authors.map(a => formatAuthor(a)).join(', ')}
                                    <br/>
                                    <span style="font-style: italic; color: var(--color-accent);">
                                        {(pub.fields.journal || pub.fields.booktitle || pub.fields.publisher || "Preprint").replace(/[{}]/g, '')}
                                    </span>
                                    {pub.fields.year && <span>, {pub.fields.year}</span>}
                                </div>
                            </div>
                        )) : <p>No publications found.</p>}
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <a href="/publications" style="font-weight: 600;">View Full List &rarr;</a>
                    </div>
                </section>

                <!-- Recent News -->
                <section>
                    <h2 style="margin-top: 0;">Lab News</h2>
                    <ul style="list-style: none; padding: 0;">
                        {posts.map((post) => (
                            <li style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px dashed var(--color-border);">
                                <a href={`/blog/${post.id}/`} style="display: block; font-family: var(--font-serif); font-size: 1.1rem; font-weight: 600; color: var(--color-text-main); margin-bottom: 0.25rem;">
                                    {post.data.title}
                                </a>
                                <small style="color: var(--color-text-muted); text-transform: uppercase; font-size: 0.8rem;">
                                    {post.data.pubDate.toLocaleDateString('en-us', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric',
                                    })}
                                </small>
                            </li>
                        ))}
                    </ul>
                    <a href="/blog" style="font-weight: 600;">View Blog &rarr;</a>
                </section>
            </div>
		</main>
		<Footer />
	</body>
</html>
